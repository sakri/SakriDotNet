<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Clouds Scan Test</title>

    <style>

        html, body {
            margin: 0;
            height: 100%;
            overflow: hidden;
        }

        #renderCanvas{
            position: absolute;
        }

    </style>

    <script src="./js/utils.js"></script>

    <script>


(function() {

    window.GridArray = function(){

        //private properties
        var _rows = 0, _cols = 0;

        //public properties
        this.array = [];

        //public API
        this.init = function(rows, cols){
            this.array.length = 0;
            _rows = rows || 10;
            _cols = cols || 10;
        };

        this.getRows = function(){
            return _rows;
        };

        this.getCols = function(){
            return _cols;
        };

        this.getSize = function(){
            return _rows * _cols;
        };

        this.getGridIndex = function(row, col){
            return row * _cols + col;
        };

        this.getRowForIndex = function(index){
            return Math.floor(index / _cols);
        };

        this.getColForIndex = function(index){
            return index % _cols;
        };

        this.isValidCol = function(col){
            return col > -1 && col < _cols;
        };

        this.isValidRow = function(row){
            return row > -1 && row < _rows;
        };

        this.isValidRowCol = function(row, col){
            return this.isValidRow(row) && this.isValidCol(col);
        };

        this.isValidIndex = function(index){
            return index > -1 && index < this.getSize();
        };

    };

}());

(function() {

    window.GridArrayScanner = {};

    //private variables
    var _scanRow = 0,
        _scanCol = 0,
        _scanRules,
        _scanRulesCW = [{x:0, y:1}, {x:-1, y:0},{x:0, y:-1},{x:1, y:0}],
        _scanRulesCC = [{x:0, y:-1}, {x:-1, y:0},{x:0, y:1},{x:1, y:0}],
        _maxScanOffset = 0;

    //public API
    GridArrayScanner.searchSurroundingCells = function(gridArray, index, compareFunction, counterClockwise){

        _scanRules = counterClockwise ? _scanRulesCC : _scanRulesCW;
        _scanRow = gridArray.getRowForIndex(index);
        _scanCol = gridArray.getColForIndex(index);

        _maxScanOffset = Math.max(
            _scanRow,
            _scanCol,
            gridArray.getRows() - _scanRow,
            gridArray.getCols() - _scanCol
        ) * 2;
        console.log("\nsearchSC() _maxOff: ", _maxScanOffset, ", index: ", index, ", _scanRow: ", _scanRow, ", _scanCol:", _scanCol);
        return surroundSearch(gridArray, index, 2, compareFunction);
    };

    var surroundSearch = function(grid, index, offset, compareFunction){
        if(offset > _maxScanOffset){
            console.log("---> boo hoo, didn't find it?", offset);
            return -1;
        }
        _scanRow = grid.getRowForIndex(index);
        _scanCol = grid.getColForIndex(index);
        console.log("ss offset:\t\t" , offset , ", row : ", _scanRow, ", col : ", _scanCol);
        var startOffset = Math.floor(offset * .5);
        _scanRow -= startOffset * _scanRules[0].y;
        _scanCol += startOffset;
        console.log("-> startOffset:\t" , startOffset , ", row : ", _scanRow, ", col : ", _scanCol);
        var total = offset * 4, scan, i, found;
        //console.log("surroundSearch() offset : ", offset, _maxScanOffset);
        for(i=0; i < total; i++){
            scan = _scanRules[Math.floor(i / offset)];
            _scanRow += scan.y;
            _scanCol += scan.x;
            if(grid.isValidRowCol(_scanRow, _scanCol)){
                //console.log("isValid : row : ", _scanRow, ", col : ", _scanCol);
                found = grid.getGridIndex(_scanRow, _scanCol);
                //console.log("grid.array[", index,"] = ", grid.array[index] , ", compare : ", compareFunction(grid.array[index]));
                if(compareFunction(grid.array[found])){
                    //console.log("whee, found it : ", index, ", offset : ", offset);
                    return grid.array[found];
                }
            }
            debugScanStep(grid, _scanRow, _scanCol);
            //console.log("scanning : row : ", _scanRow, ", col : ", _scanCol);

        }
        return surroundSearch(grid, index, offset + 2, compareFunction);
    };

}());

var debugStep = 0;
var debugScanStep = function(grid, row, col){
    var color = "rgba(0,0,0," +(.1 + .01 * debugStep) + ")";
    debugStep++;
    renderGridCell(grid, row, col, color);
};

var renderGridCellIndex = function(grid, index, color){
    var row = grid.getRowForIndex(index);
    var col = grid.getColForIndex(index);
    renderGridCell(grid, row, col, color);
};

var renderGridCell = function(grid, row, col, color){
    context.fillStyle = color;
    context.fillRect(gridBounds.x + cellSize * col, gridBounds.y + cellSize * row, cellSize, cellSize);
};

var gridBounds = new Rectangle();
var cellSize = 0;
var testScan = function(){
    var gridSize = 10;
    gridBounds.width = gridBounds.height = Math.floor(Math.min(canvas.width, canvas.height) * .4);
    gridBounds.x = Math.floor(canvas.width * .5 - gridBounds.width * .5);
    gridBounds.y = Math.floor(canvas.height * .5 - gridBounds.height * .5);
    cellSize = gridBounds.width / gridSize;
    var grid = new GridArray();
    grid.init(gridSize, gridSize);

    context.fillStyle = "#FFCCCC";
    context.fillRect(gridBounds.x, gridBounds.y, gridBounds.width, gridBounds.height);

    var testCellIndex = Math.floor(Math.random() * grid.getSize());
    renderGridCellIndex(grid, testCellIndex, "#FF0000");

    var scanStartIndex = testCellIndex;
    while(scanStartIndex == testCellIndex){
        scanStartIndex = Math.floor(Math.random() * grid.getSize());
    }
    renderGridCellIndex(grid, scanStartIndex, "#0000FF");

    for(var i=0; i<grid.getSize(); i++){
        grid.array[i] = -1;
    }
    grid.array[testCellIndex] = testCellIndex;

    var scanResultIndex = GridArrayScanner.searchSurroundingCells(grid, scanStartIndex, gridCompare);
    console.log("found index : ", scanResultIndex, ", should be : ",  testCellIndex);
    renderGridCellIndex(grid, grid.array[scanResultIndex], "#00FF00");

};

var gridCompare = function(value){
    return value > -1;
}

var canvas, context;
var init = function() {
    canvas = document.getElementById("renderCanvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    context = canvas.getContext("2d");
    testScan();
};

    </script>

</head>
<body onload="init()" >
    <canvas id="renderCanvas" ></canvas>
</body>

</html>